"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3410],{3905:(e,a,t)=>{t.d(a,{Zo:()=>s,kt:()=>c});var n=t(67294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=n.createContext({}),m=function(e){var a=n.useContext(p),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},s=function(e){var a=m(e.components);return n.createElement(p.Provider,{value:a},e.children)},k="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),k=m(t),u=r,c=k["".concat(p,".").concat(u)]||k[u]||d[u]||i;return t?n.createElement(c,l(l({ref:a},s),{},{components:t})):n.createElement(c,l({ref:a},s))}));function c(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=t.length,l=new Array(i);l[0]=u;var o={};for(var p in a)hasOwnProperty.call(a,p)&&(o[p]=a[p]);o.originalType=e,o[k]="string"==typeof e?e:r,l[1]=o;for(var m=2;m<i;m++)l[m]=t[m];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},28678:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>p,contentTitle:()=>l,default:()=>k,frontMatter:()=>i,metadata:()=>o,toc:()=>m});var n=t(87462),r=(t(67294),t(3905));const i={},l="Documenta\xe7\xe3o \u2014 Integra\xe7\xe3o SK - B2B Fabritech",o={unversionedId:"Processos/integracao_b2b_fabritech_sk",id:"Processos/integracao_b2b_fabritech_sk",title:"Documenta\xe7\xe3o \u2014 Integra\xe7\xe3o SK - B2B Fabritech",description:"Fonte: skpostfabritech",source:"@site/docs/5-Processos/integracao_b2b_fabritech_sk.md",sourceDirName:"5-Processos",slug:"/Processos/integracao_b2b_fabritech_sk",permalink:"/docushark/docs/Processos/integracao_b2b_fabritech_sk",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Forma\xe7\xe3o de pre\xe7o SK",permalink:"/docushark/docs/Processos/formacao_preco_sk"},next:{title:"Libera\xe7\xe3o de pre\xe7o",permalink:"/docushark/docs/Processos/liberacao_preco"}},p={},m=[{value:"Vis\xe3o Geral",id:"vis\xe3o-geral",level:2},{value:"Estrutura e conven\xe7\xf5es",id:"estrutura-e-conven\xe7\xf5es",level:2},{value:"\xcdndice",id:"\xedndice",level:2},{value:"SKEnvPrd",id:"skenvprd",level:2},{value:"EnviaLote",id:"envialote",level:2},{value:"PreparaAtualizacao",id:"preparaatualizacao",level:2},{value:"AtuZK1Batch",id:"atuzk1batch",level:2},{value:"UpdateBatch",id:"updatebatch",level:2},{value:"AtuZK1Individual",id:"atuzk1individual",level:2},{value:"Utilit\xe1rios: Implode, IsOracle, StrSanitize",id:"utilit\xe1rios-implode-isoracle-strsanitize",level:2},{value:"Implode",id:"implode",level:3},{value:"StrSanitize",id:"strsanitize",level:3},{value:"ParseOriginalJson",id:"parseoriginaljson",level:2},{value:"GenProdJson",id:"genprodjson",level:2},{value:"Manuf. e Categoria (GetManufInfo, GetProdGroup, GetManufName, GetLocCat)",id:"manuf-e-categoria-getmanufinfo-getprodgroup-getmanufname-getloccat",level:2},{value:"Relacionamentos (GetRelPrdJ, GetAltProd, GetRelProd)",id:"relacionamentos-getrelprdj-getaltprod-getrelprod",level:2},{value:"Pre\xe7os (GetPricesJ, GetPrcData, ProcPrcRecFull)",id:"pre\xe7os-getpricesj-getprcdata-procprcrecfull",level:2},{value:"Estoque (GetStockJs, GetStockData, ProcStockRec, GetStockQt)",id:"estoque-getstockjs-getstockdata-procstockrec-getstockqt",level:2},{value:"SKaltPrc",id:"skaltprc",level:2},{value:"ProcessaProdutoPreco",id:"processaprodutopreco",level:2},{value:"PUTPRECO",id:"putpreco",level:2},{value:"RETUFFIL (RETFIL/RETFIL?)",id:"retuffil-retfilretfil",level:2},{value:"SKCarZk2 / InsereZk2",id:"skcarzk2--inserezk2",level:2},{value:"SKEnvEst / GenEstqJson / EnvLotEstq / AtuZK2Batch / UpdZK2Batch / AtuZK2Ind",id:"skenvest--genestqjson--envlotestq--atuzk2batch--updzk2batch--atuzk2ind",level:2},{value:"Notas de Qualidade, Melhorias e Pontos de Aten\xe7\xe3o",id:"notas-de-qualidade-melhorias-e-pontos-de-aten\xe7\xe3o",level:2},{value:"Mindmap (estrutura hier\xe1rquica para importa\xe7\xe3o)",id:"mindmap-estrutura-hier\xe1rquica-para-importa\xe7\xe3o",level:2}],s={toc:m};function k(e){let{components:a,...t}=e;return(0,r.kt)("wrapper",(0,n.Z)({},s,t,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"documenta\xe7\xe3o--integra\xe7\xe3o-sk---b2b-fabritech"},"Documenta\xe7\xe3o \u2014 Integra\xe7\xe3o SK - B2B Fabritech"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Fonte: skpostfabritech")," "),(0,r.kt)("p",null,"Analista: Jose Antonio"),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"vis\xe3o-geral"},"Vis\xe3o Geral"),(0,r.kt)("p",null,"Integra\xe7\xf5es entre o Protheus (tabelas ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK2"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"PVF"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"SB1"),", etc.) e a plataforma B2B Fabritech (via API REST), trabalhando com:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Envio de produtos (JSON) recebidos da VTEX para Fabritech."),(0,r.kt)("li",{parentName:"ul"},"Envio de estoques por filial."),(0,r.kt)("li",{parentName:"ul"},"Sinaliza\xe7\xe3o de altera\xe7\xf5es de pre\xe7o e envio via PUT."),(0,r.kt)("li",{parentName:"ul"},"Atualiza\xe7\xf5es em lote nas tabelas de controle (",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2"),").")),(0,r.kt)("p",null,"O objetivo desta documenta\xe7\xe3o \xe9 ",(0,r.kt)("strong",{parentName:"p"},"descrever cada fun\xe7\xe3o"),", explicar par\xe2metros, retornos, depend\xeancias e pontos de aten\xe7\xe3o \u2014 e tamb\xe9m servir como estrutura para convers\xe3o em ",(0,r.kt)("em",{parentName:"p"},"mindmap"),"."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"estrutura-e-conven\xe7\xf5es"},"Estrutura e conven\xe7\xf5es"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ZK1")," \u2014 tabela de produtos recebidos da VTEX."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ZK2")," \u2014 tabela de estoques por produto/filial."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"PVF"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"SB1"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"SA2"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"ACV"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"ACU")," \u2014 tabelas do Protheus usadas nas consultas."),(0,r.kt)("li",{parentName:"ul"},"Conven\xe7\xe3o de status:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"P")," = Pendente (para envio)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"I")," = Integrado (sucesso)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"F")," = Falha."))),(0,r.kt)("li",{parentName:"ul"},"Muitas fun\xe7\xf5es usam ",(0,r.kt)("inlineCode",{parentName:"li"},"GetNextAlias()")," e consultas via ",(0,r.kt)("inlineCode",{parentName:"li"},"MPSysOpenQuery(...)"),".")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"\xedndice"},"\xcdndice"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#skenvprd"},"SKEnvPrd")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#envialote"},"EnviaLote")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#preparaatualizacao"},"PreparaAtualizacao")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#atuzk1batch"},"AtuZK1Batch")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#updatebatch"},"UpdateBatch")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#atuzk1individual"},"AtuZK1Individual")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#skaltprc"},"SKaltPrc")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#processaprodutopreco"},"ProcessaProdutoPreco")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#putpreco"},"PUTPRECO")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#parseoriginaljson"},"ParseOriginalJson")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#genprodjson"},"GenProdJson")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#manuf-e-categoria"},"GetManufInfo / GetProdGroup / GetManufName / GetLocCat")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#utils"},"StrSanitize / Implode / IsOracle")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#precos"},"GetPricesJ / GetPrcData / ProcPrcRecFull")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#estoque"},"GetStockJs / GetStockData / ProcStockRec / GetStockQt")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#skcarzk2"},"SKCarZk2 / InsereZk2")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#envio-estoque"},"SKEnvEst / GenEstqJson / EnvLotEstq / AtuZK2Batch / UpdZK2Batch / AtuZK2Ind")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#retuffil"},"RETUFFIL")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#melhorias"},"Notas de qualidade, melhorias e erros comuns")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#mindmap"},"Mindmap (formato baseado em headings)"))),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"skenvprd"},"SKEnvPrd"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"User Function SKEnvPrd(nLoteSize, lTestMode)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o curta:")," Varre a tabela ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," buscando produtos recebidos da VTEX (status ",(0,r.kt)("inlineCode",{parentName:"p"},"'P'"),") e n\xe3o enviados para a Fabritech, formata JSONs via ",(0,r.kt)("inlineCode",{parentName:"p"},"GenProdJson"),", agrupa em lotes e envia via ",(0,r.kt)("inlineCode",{parentName:"p"},"EnviaLote"),". Atualiza ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," em lote com resultados."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nLoteSize")," (opcional): tamanho m\xe1ximo do lote. Aceita num\xe9rico ou string num\xe9rica. Default interno usado: 100 (ajusta para 50 se <= 0)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"lTestMode")," (opcional): ",(0,r.kt)("inlineCode",{parentName:"li"},".T.")," para simular (n\xe3o envia).")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"array [total_processado, sucesso_geral, lotes_enviados, detalhes_erros]")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Passo a passo:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Salva contexto/\xe1rea atual (",(0,r.kt)("inlineCode",{parentName:"li"},"GetArea()"),")."),(0,r.kt)("li",{parentName:"ol"},"Ajusta ",(0,r.kt)("inlineCode",{parentName:"li"},"nMaxLote")," tratando ",(0,r.kt)("inlineCode",{parentName:"li"},"nLoteSize"),"."),(0,r.kt)("li",{parentName:"ol"},"Se necess\xe1rio, chama ",(0,r.kt)("inlineCode",{parentName:"li"},"RpcSetEnv(...)")," para configurar ambiente."),(0,r.kt)("li",{parentName:"ol"},"Obt\xe9m token com ",(0,r.kt)("inlineCode",{parentName:"li"},"U_GetB2BTk()")," \u2014 se falhar, retorna erro."),(0,r.kt)("li",{parentName:"ol"},"Monta query para selecionar produtos em ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1")," com ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1_ATUALI = 'P'")," e n\xe3o integrados (",(0,r.kt)("inlineCode",{parentName:"li"},"!= 'V'"),").",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Quando Oracle, reconstitui campos LONG/Lob (uses ",(0,r.kt)("inlineCode",{parentName:"li"},"UTL_RAW.CAST_TO_VARCHAR2(DBMS_LOB.SUBSTR(...))"),")."))),(0,r.kt)("li",{parentName:"ol"},"Para cada registro:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Reconstroi JSON original (concatena peda\xe7os em Oracle)."),(0,r.kt)("li",{parentName:"ul"},"Faz parse seguro com ",(0,r.kt)("inlineCode",{parentName:"li"},"ParseOriginalJson"),"."),(0,r.kt)("li",{parentName:"ul"},"Valida m\xednimo: ",(0,r.kt)("inlineCode",{parentName:"li"},"RefId")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"Name"),"."),(0,r.kt)("li",{parentName:"ul"},"Gera novo JSON com ",(0,r.kt)("inlineCode",{parentName:"li"},"GenProdJson"),"."),(0,r.kt)("li",{parentName:"ul"},"Acumula JSONs e c\xf3digos em ",(0,r.kt)("inlineCode",{parentName:"li"},"aLote")," / ",(0,r.kt)("inlineCode",{parentName:"li"},"aLoteCodes"),"."),(0,r.kt)("li",{parentName:"ul"},"Quando lote atinge ",(0,r.kt)("inlineCode",{parentName:"li"},"nMaxLote"),", chama ",(0,r.kt)("inlineCode",{parentName:"li"},"EnviaLote")," (a menos que ",(0,r.kt)("inlineCode",{parentName:"li"},"lTestMode"),"), registra sucesso/falha em ",(0,r.kt)("inlineCode",{parentName:"li"},"aData")," via ",(0,r.kt)("inlineCode",{parentName:"li"},"PreparaAtualizacao"),"."),(0,r.kt)("li",{parentName:"ul"},"Periodicamente chama ",(0,r.kt)("inlineCode",{parentName:"li"},"AtuZK1Batch(aData)")," quando ",(0,r.kt)("inlineCode",{parentName:"li"},"aData")," atinge 100 itens."))),(0,r.kt)("li",{parentName:"ol"},"Ao final envia \xfaltimo lote (se existir) e faz \xfaltima atualiza\xe7\xe3o em ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1"),"."),(0,r.kt)("li",{parentName:"ol"},"Restaura ambiente e retorna resumo.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Pontos importantes / erros comuns:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Depende de ",(0,r.kt)("inlineCode",{parentName:"li"},"U_GetB2BTk()"),"; sem token o envio n\xe3o ocorre."),(0,r.kt)("li",{parentName:"ul"},"JSONs muito grandes no Oracle s\xe3o reconstru\xeddos por m\xfaltiplos campos ",(0,r.kt)("inlineCode",{parentName:"li"},"Json1..Json99"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"lTestMode")," \xfatil para debug (n\xe3o chama web service)."),(0,r.kt)("li",{parentName:"ul"},"Mensagens de log com ",(0,r.kt)("inlineCode",{parentName:"li"},"ConOut(...)")," para acompanhamento.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"envialote"},"EnviaLote"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function EnviaLote(aLote, cToken, aErrors)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Junta uma lista de JSONs (",(0,r.kt)("inlineCode",{parentName:"p"},"aLote"),") em um array JSON e faz envio via ",(0,r.kt)("inlineCode",{parentName:"p"},'U_EnvLoteB2B("PRODUTOS", cJsonFinal, cToken)')," com at\xe9 3 tentativas. Registra erros em ",(0,r.kt)("inlineCode",{parentName:"p"},"aErrors"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aLote")," \u2014 array de strings (JSONs)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cToken")," \u2014 token de autentica\xe7\xe3o."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aErrors")," \u2014 array passado por refer\xeancia para armazenar mensagens de erro.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," ",(0,r.kt)("inlineCode",{parentName:"p"},".T.")," se sucesso."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Passos:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Monta string ",(0,r.kt)("inlineCode",{parentName:"li"},'cJsonFinal = "[" + items + "]"'),", validando que cada item seja texto (",(0,r.kt)("inlineCode",{parentName:"li"},'ValType == "C"'),")."),(0,r.kt)("li",{parentName:"ol"},"Se problema na forma\xe7\xe3o do JSON, adiciona erro em ",(0,r.kt)("inlineCode",{parentName:"li"},"aErrors")," e retorna ",(0,r.kt)("inlineCode",{parentName:"li"},".F."),"."),(0,r.kt)("li",{parentName:"ol"},"Loop de tentativas (1..3):",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Se tentativa > 1, renova token com ",(0,r.kt)("inlineCode",{parentName:"li"},"U_GetB2BTk()")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"Sleep"),"."),(0,r.kt)("li",{parentName:"ul"},"Chama ",(0,r.kt)("inlineCode",{parentName:"li"},"U_EnvLoteB2B"),"."),(0,r.kt)("li",{parentName:"ul"},"Em caso de erro registra ",(0,r.kt)("inlineCode",{parentName:"li"},"TCSQLERROR()")," (ou mensagem desconhecida)."))),(0,r.kt)("li",{parentName:"ol"},"Log de sucesso ou falha ap\xf3s 3 tentativas.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Observa\xe7\xf5es:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Reaproveita ",(0,r.kt)("inlineCode",{parentName:"li"},"U_EnvLoteB2B")," (fun\xe7\xe3o externa do c\xf3digo base)."),(0,r.kt)("li",{parentName:"ul"},"Retentativas com pequeno backoff.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"preparaatualizacao"},"PreparaAtualizacao"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function PreparaAtualizacao(aLote, aData, lSuccess, aCodes)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Para cada item do lote adiciona um registro em ",(0,r.kt)("inlineCode",{parentName:"p"},"aData")," com o c\xf3digo, status (",(0,r.kt)("inlineCode",{parentName:"p"},"I")," ou ",(0,r.kt)("inlineCode",{parentName:"p"},"F"),"), data, hora e mensagem (em caso de erro). Usada para atualiza\xe7\xe3o em lote posterior."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aLote")," \u2014 array de JSONs (n\xe3o usado diretamente al\xe9m do loop)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aData")," \u2014 array (refer\xeancia) que ser\xe1 preenchido."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"lSuccess")," \u2014 status booleano do envio do lote."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aCodes")," \u2014 array com c\xf3digos dos itens do lote.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," void (modifica ",(0,r.kt)("inlineCode",{parentName:"p"},"aData")," por refer\xeancia)."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"atuzk1batch"},"AtuZK1Batch"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function AtuZK1Batch(aData)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Atualiza a tabela ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," em lotes, separando registros com sucesso e falha. Usa ",(0,r.kt)("inlineCode",{parentName:"p"},"UpdateBatch")," para atualiza\xe7\xf5es em lote e, em caso de falha, usa ",(0,r.kt)("inlineCode",{parentName:"p"},"AtuZK1Individual"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"aData")," \u2014 array de arrays com formato ",(0,r.kt)("inlineCode",{parentName:"p"},"[codigo, status, data, hora, msg]"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Detalhes operacionais:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Separa ",(0,r.kt)("inlineCode",{parentName:"li"},"aData")," em ",(0,r.kt)("inlineCode",{parentName:"li"},"aCodesI")," (sucesso) e ",(0,r.kt)("inlineCode",{parentName:"li"},"aCodesF")," (falha)."),(0,r.kt)("li",{parentName:"ul"},"Atualiza em lotes (",(0,r.kt)("inlineCode",{parentName:"li"},"nBatchSize = 500"),") via ",(0,r.kt)("inlineCode",{parentName:"li"},"UpdateBatch"),"."),(0,r.kt)("li",{parentName:"ul"},"Se ",(0,r.kt)("inlineCode",{parentName:"li"},"UpdateBatch")," falhar tenta atualizar individualmente via ",(0,r.kt)("inlineCode",{parentName:"li"},"AtuZK1Individual"),".")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"updatebatch"},"UpdateBatch"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function UpdateBatch(cStatus, aCodes, nStart, nEnd, cData, cHora, cMsg)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Monta e executa uma query SQL ",(0,r.kt)("inlineCode",{parentName:"p"},"UPDATE ... WHERE ZK1_CODIGO IN (...)")," para atualizar v\xe1rios c\xf3digos de uma s\xf3 vez. Remove marca\xe7\xf5es de encoding ",(0,r.kt)("inlineCode",{parentName:"p"},"[UTF-8]")," antes de executar."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros importantes:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cStatus"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"'I'")," ou ",(0,r.kt)("inlineCode",{parentName:"li"},"'F'"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aCodes"),": array de c\xf3digos."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nStart"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"nEnd"),": limites do sub-lote."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cData"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"cHora"),": valores para ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1_DTINTE")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1_HRINTE"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cMsg"),": mensagem de erro.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retornos:")," ",(0,r.kt)("inlineCode",{parentName:"p"},".T.")," se sucesso."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Observa\xe7\xf5es:")," Verifica retorno ",(0,r.kt)("inlineCode",{parentName:"p"},"TCSQLEXEC(cQuery) < 0")," para detectar erro e loga ",(0,r.kt)("inlineCode",{parentName:"p"},"TCSQLERROR()"),"."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"atuzk1individual"},"AtuZK1Individual"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function AtuZK1Individual(aData, cFilterStatus)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Atualiza ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," um a um. Usada como fallback quando ",(0,r.kt)("inlineCode",{parentName:"p"},"UpdateBatch")," falha."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"aData"),": array com os dados."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cFilterStatus"),": se informado, atualiza apenas registros com este status.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Observa\xe7\xf5es:")," Faz ",(0,r.kt)("inlineCode",{parentName:"p"},"TCSQLEXEC")," por registro e loga query (parcial) em caso de erro."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"utilit\xe1rios-implode-isoracle-strsanitize"},"Utilit\xe1rios: Implode, IsOracle, StrSanitize"),(0,r.kt)("h3",{id:"implode"},"Implode"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function Implode(cSeparator, aArray)"),"\nConcatena elementos de ",(0,r.kt)("inlineCode",{parentName:"p"},"aArray")," com separador ",(0,r.kt)("inlineCode",{parentName:"p"},"cSeparator"),". Retorna string."),(0,r.kt)("h3",{id:"strsanitize"},"StrSanitize"),(0,r.kt)("p",null,"Remove aspas duplas, quebras de linha e faz ",(0,r.kt)("inlineCode",{parentName:"p"},"AllTrim"),". Usada para preparar strings para JSON."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"parseoriginaljson"},"ParseOriginalJson"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function ParseOriginalJson(cJson)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Recebe ",(0,r.kt)("inlineCode",{parentName:"p"},"cJson")," (string) e retorna ",(0,r.kt)("inlineCode",{parentName:"p"},"JsonObject()")," com ",(0,r.kt)("inlineCode",{parentName:"p"},"fromJson(cJson)"),"; em caso de erro retorna ",(0,r.kt)("inlineCode",{parentName:"p"},"Nil"),". Loga aviso/erro via ",(0,r.kt)("inlineCode",{parentName:"p"},"ConOut"),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Pontos cr\xedticos:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Se o JSON estiver vazio ou for inv\xe1lido retorna ",(0,r.kt)("inlineCode",{parentName:"li"},"Nil"),"."),(0,r.kt)("li",{parentName:"ul"},"Em Oracle o JSON pode estar fragmentado em v\xe1rios campos \u2014 reconstru\xeddo antes desta chamada.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"genprodjson"},"GenProdJson"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function GenProdJson(oProd)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Gera o JSON no formato esperado pela Fabritech a partir do objeto original ",(0,r.kt)("inlineCode",{parentName:"p"},"oProd")," (parseado do JSON vindo da VTEX). Junta dados de fabricante, categorias, imagens, relacionamentos, pre\xe7os e estoques."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Par\xe2metros:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"oProd")," \u2014 objeto JSON (tipo ",(0,r.kt)("inlineCode",{parentName:"p"},"J"),")."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," string JSON formatada (ou ",(0,r.kt)("inlineCode",{parentName:"p"},'""')," em caso de falha)."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"L\xf3gica (resumida, passo a passo):")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Valida ",(0,r.kt)("inlineCode",{parentName:"li"},"oProd")," (",(0,r.kt)("inlineCode",{parentName:"li"},'ValType(oProd) == "J"'),")."),(0,r.kt)("li",{parentName:"ol"},"Garante que ",(0,r.kt)("inlineCode",{parentName:"li"},"RefId")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"Name")," existam (fallback para ",(0,r.kt)("inlineCode",{parentName:"li"},'""'),")."),(0,r.kt)("li",{parentName:"ol"},"Obt\xe9m ",(0,r.kt)("inlineCode",{parentName:"li"},"oManuf := GetManufInfo(RefId)"),"."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"cGroup := GetProdGroup(oManuf)")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"cManuf := GetManufName(oManuf)"),"."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("inlineCode",{parentName:"li"},"oCat := GetLocCat(RefId)")," \u2014 se existir inclui estrutura de categorias com ",(0,r.kt)("inlineCode",{parentName:"li"},"oCat:ToJson()"),"; sen\xe3o usa ",(0,r.kt)("inlineCode",{parentName:"li"},'oProd["Category"]'),"."),(0,r.kt)("li",{parentName:"ol"},"Monta campos principais (",(0,r.kt)("inlineCode",{parentName:"li"},"_id"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"name"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"slug"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"description"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"brand"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"manufacturer"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"ean/barcode"),", etc)."),(0,r.kt)("li",{parentName:"ol"},"Insere ",(0,r.kt)("inlineCode",{parentName:"li"},"technicalSpecification")," a partir do SKU quando presente; faz consulta em ",(0,r.kt)("inlineCode",{parentName:"li"},"SB1")," para quantidade por caixa (",(0,r.kt)("inlineCode",{parentName:"li"},"B1_XLOTVEN"),")."),(0,r.kt)("li",{parentName:"ol"},"Adiciona arrays de ",(0,r.kt)("inlineCode",{parentName:"li"},"image"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"alternatives"),"/",(0,r.kt)("inlineCode",{parentName:"li"},"related")," via ",(0,r.kt)("inlineCode",{parentName:"li"},"GetRelPrdJ"),"."),(0,r.kt)("li",{parentName:"ol"},"Anexa ",(0,r.kt)("inlineCode",{parentName:"li"},"prices")," via ",(0,r.kt)("inlineCode",{parentName:"li"},"GetPricesJ")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"stocks")," via ",(0,r.kt)("inlineCode",{parentName:"li"},"GetStockJs"),"."),(0,r.kt)("li",{parentName:"ol"},"Retorna ",(0,r.kt)("inlineCode",{parentName:"li"},"cJson")," se come\xe7ar com ",(0,r.kt)("inlineCode",{parentName:"li"},"{"),", sen\xe3o ",(0,r.kt)("inlineCode",{parentName:"li"},'""'),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Pontos de aten\xe7\xe3o:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Usa ",(0,r.kt)("inlineCode",{parentName:"li"},"StrSanitize")," para limpar textos."),(0,r.kt)("li",{parentName:"ul"},"Se ",(0,r.kt)("inlineCode",{parentName:"li"},"Skus")," estiver vazio muitos campos t\xe9cnicos ficam com 0 ou vazio."),(0,r.kt)("li",{parentName:"ul"},"Faz consulta em ",(0,r.kt)("inlineCode",{parentName:"li"},"SB1")," para montar ",(0,r.kt)("inlineCode",{parentName:"li"},"boxQuantity"),"."),(0,r.kt)("li",{parentName:"ul"},"Se alguma fun\xe7\xe3o auxiliar falhar (ex: ",(0,r.kt)("inlineCode",{parentName:"li"},"GetLocCat"),") \xe9 aplicado fallback.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"manuf-e-categoria-getmanufinfo-getprodgroup-getmanufname-getloccat"},"Manuf. e Categoria (GetManufInfo, GetProdGroup, GetManufName, GetLocCat)"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetManufInfo(cProdCod)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Query em ",(0,r.kt)("inlineCode",{parentName:"li"},"SB1")," para obter ",(0,r.kt)("inlineCode",{parentName:"li"},"codFab"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"codMarca"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"codGrupo"),". Retorna ",(0,r.kt)("inlineCode",{parentName:"li"},"JsonObject")," com estes campos ou objeto vazio.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetProdGroup(oManuf)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Se ",(0,r.kt)("inlineCode",{parentName:"li"},'oManuf["codGrupo"]')," existir, consulta ",(0,r.kt)("inlineCode",{parentName:"li"},"SBM")," e retorna ",(0,r.kt)("inlineCode",{parentName:"li"},"BM_DESC"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetManufName(oManuf)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Se ",(0,r.kt)("inlineCode",{parentName:"li"},'oManuf["codFab"]')," existir, consulta ",(0,r.kt)("inlineCode",{parentName:"li"},"SA2")," e retorna ",(0,r.kt)("inlineCode",{parentName:"li"},"A2_NOME"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetLocCat(cProdCod)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"L\xea tabela ",(0,r.kt)("inlineCode",{parentName:"li"},"ACV")," para categoria do produto e, com ",(0,r.kt)("inlineCode",{parentName:"li"},"WITH")," (CatHierarchy), percorre n\xedveis de categoria em ",(0,r.kt)("inlineCode",{parentName:"li"},"ACU")," e monta JSON com levels (3=department, 2=category, 1=subcategory). Retorna objeto JSON ou vazio.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"relacionamentos-getrelprdj-getaltprod-getrelprod"},"Relacionamentos (GetRelPrdJ, GetAltProd, GetRelProd)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GetAltProd"),": Busca em ",(0,r.kt)("inlineCode",{parentName:"li"},"VB1")," por alternativas; monta lista \xfanica."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GetRelProd"),": Busca em ",(0,r.kt)("inlineCode",{parentName:"li"},"VPD")," por produtos relacionados; monta lista \xfanica."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"GetRelPrdJ"),": Monta os arrays ",(0,r.kt)("inlineCode",{parentName:"li"},'"alternatives":[...]')," e ",(0,r.kt)("inlineCode",{parentName:"li"},'"related":[...]')," em JSON pronto para inclus\xe3o na sa\xedda do produto.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"pre\xe7os-getpricesj-getprcdata-procprcrecfull"},"Pre\xe7os (GetPricesJ, GetPrcData, ProcPrcRecFull)"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetPricesJ(cProdCod)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Usa ",(0,r.kt)("inlineCode",{parentName:"li"},"GetPrcData")," para coletar registros de pre\xe7o (",(0,r.kt)("inlineCode",{parentName:"li"},"PVF"),"), comp\xf5e array JSON de pre\xe7os e retorna como ",(0,r.kt)("inlineCode",{parentName:"li"},'"prices":[...],')," ou, em contexto de outra chamada (",(0,r.kt)("inlineCode",{parentName:"li"},"U_SKaltPrc"),"), retorna objeto JSON.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetPrcData(cProdCod)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Executa uma query complexa com ",(0,r.kt)("inlineCode",{parentName:"li"},"ROW_NUMBER()")," para obter pre\xe7os por UF (cada ",(0,r.kt)("inlineCode",{parentName:"li"},"PVF")," por UF). Para cada linha chama ",(0,r.kt)("inlineCode",{parentName:"li"},"ProcPrcRecFull"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ProcPrcRecFull(cAlias)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Processa todos os campos de pre\xe7o do registro ",(0,r.kt)("inlineCode",{parentName:"li"},"PVF"),", cria strings JSON para cada pre\xe7o com ",(0,r.kt)("inlineCode",{parentName:"li"},"id"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"name"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"promotion")," (false) e ",(0,r.kt)("inlineCode",{parentName:"li"},"value"),". Retorna uma estrutura contendo o ",(0,r.kt)("inlineCode",{parentName:"li"},"uf"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"aItems"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"aStrs")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"cAll")," (concatena\xe7\xe3o).")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"estoque-getstockjs-getstockdata-procstockrec-getstockqt"},"Estoque (GetStockJs, GetStockData, ProcStockRec, GetStockQt)"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetStockJs(cProdCod)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Retorna a string ",(0,r.kt)("inlineCode",{parentName:"li"},'"stocks":[...]')," usando ",(0,r.kt)("inlineCode",{parentName:"li"},"GetStockData"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetStockData(cProdCod)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Query em ",(0,r.kt)("inlineCode",{parentName:"li"},"PVF")," por ",(0,r.kt)("inlineCode",{parentName:"li"},"PVF_CODFIL, PVF_UF")," e chama ",(0,r.kt)("inlineCode",{parentName:"li"},"ProcStockRec")," por filial.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ProcStockRec(cProdCod, cAlias, aStock)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Para cada filial listada em MV (",(0,r.kt)("inlineCode",{parentName:"li"},"ES_FILB2B"),") busca entrada em ",(0,r.kt)("inlineCode",{parentName:"li"},"SZP")," e chama ",(0,r.kt)("inlineCode",{parentName:"li"},"GetStockQt")," para obter saldo (fun\xe7\xe3o ",(0,r.kt)("inlineCode",{parentName:"li"},"u_specc013")," usada para c\xe1lculo). Monta objeto ",(0,r.kt)("inlineCode",{parentName:"li"},'{ "id":"09,filial", "name":"filial UF", "value":qtd }')," e adiciona em ",(0,r.kt)("inlineCode",{parentName:"li"},"aStock"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GetStockQt(cProdCod, cFilOrig, cUF)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Chama ",(0,r.kt)("inlineCode",{parentName:"li"},"u_specc013")," (fun\xe7\xe3o externa) para obter saldo. Retorna array ",(0,r.kt)("inlineCode",{parentName:"li"},"[cProdCod, cFilOrig, cUF, saldo]")," com tratamento de saldo negativo.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"skaltprc"},"SKaltPrc"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"User Function SKaltPrc()")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Verifica na tabela ",(0,r.kt)("inlineCode",{parentName:"p"},"PVF")," por produtos cujo ",(0,r.kt)("inlineCode",{parentName:"p"},"PVF_DTCALC/PVF_HRCALC")," s\xe3o posteriores ao \xfaltimo envio em ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," (ou seja, pre\xe7os atualizados desde a \xfaltima integra\xe7\xe3o) e dispara ",(0,r.kt)("inlineCode",{parentName:"p"},"ProcessaProdutoPreco")," para cada um, sinalizando os produtos que devem ser atualizados via API (PUT)."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"[total_processado, total_sinalizados, detalhes_erros]")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Fluxo:")),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Ajusta ambiente (RPC) se necess\xe1rio."),(0,r.kt)("li",{parentName:"ol"},"Query eficiente com ",(0,r.kt)("inlineCode",{parentName:"li"},"GROUP BY")," para trazer produtos com ",(0,r.kt)("inlineCode",{parentName:"li"},"PVF")," mais recente que ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1"),"."),(0,r.kt)("li",{parentName:"ol"},"Coleta todos os produtos em mem\xf3ria ",(0,r.kt)("inlineCode",{parentName:"li"},"aProdutos"),"."),(0,r.kt)("li",{parentName:"ol"},"Obt\xe9m token ",(0,r.kt)("inlineCode",{parentName:"li"},"U_GetB2BTk()"),"."),(0,r.kt)("li",{parentName:"ol"},"Para cada produto chama ",(0,r.kt)("inlineCode",{parentName:"li"},"ProcessaProdutoPreco(...)"),"."),(0,r.kt)("li",{parentName:"ol"},"Restaura ambiente e retorna resumo.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"processaprodutopreco"},"ProcessaProdutoPreco"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function ProcessaProdutoPreco(cProduto, cDataAlt, cHoraAlt, cToken, aErrors)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Marca produto como pendente (",(0,r.kt)("inlineCode",{parentName:"p"},"'P'"),") em ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1"),", gera JSON de pre\xe7os (",(0,r.kt)("inlineCode",{parentName:"p"},"GetPricesJ"),"), tenta enviar via ",(0,r.kt)("inlineCode",{parentName:"p"},"PUTPRECO")," (com retentativas), atualiza ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," com resultado."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," em sucesso, ",(0,r.kt)("inlineCode",{parentName:"p"},"0")," em falha."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Detalhes:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Faz at\xe9 3 tentativas; renova token em cada tentativa se necess\xe1rio."),(0,r.kt)("li",{parentName:"ul"},"No sucesso chama ",(0,r.kt)("inlineCode",{parentName:"li"},'AtualizaStatusZK1(cProduto, "I", ...)'),"."),(0,r.kt)("li",{parentName:"ul"},"Em falha ao final chama ",(0,r.kt)("inlineCode",{parentName:"li"},'AtualizaStatusZK1(cProduto, "F", ...)'),".")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"putpreco"},"PUTPRECO"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"Static Function PUTPRECO(cProduto, cJson, cToken, cObsInt)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," Monta e executa requisi\xe7\xe3o HTTP ",(0,r.kt)("inlineCode",{parentName:"p"},"PUT")," para ",(0,r.kt)("inlineCode",{parentName:"p"},'"/v1/collection/products/"+cProduto')," usando ",(0,r.kt)("inlineCode",{parentName:"p"},"FWRest()")," com headers (Content-Type, Accept, Origin, Authorization). Envia JSON de pre\xe7os no corpo (EncodeUTF8 para cp1252)."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Retorno:")," ",(0,r.kt)("inlineCode",{parentName:"p"},".T.")," se status HTTP entre 200 e 299."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Efeito colateral:")," Atualiza registro ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1")," (status, data/hora e ",(0,r.kt)("inlineCode",{parentName:"p"},"ZK1_OBSINT"),") conforme resultado."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Erros comuns:")," Falha de rede, token inv\xe1lido, status 4xx. ",(0,r.kt)("inlineCode",{parentName:"p"},"HTTPGetStatus(@cError)")," \xe9 usado para obter c\xf3digo."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"retuffil-retfilretfil"},"RETUFFIL (RETFIL/RETFIL?)"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Assinatura:")," ",(0,r.kt)("inlineCode",{parentName:"p"},"STATIC FUNCTION RETUFFIL(cEmpOri, cFilOri)")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Descri\xe7\xe3o:")," L\xea tabela ",(0,r.kt)("inlineCode",{parentName:"p"},"SZP")," para retornar informa\xe7\xf5es da filial (",(0,r.kt)("inlineCode",{parentName:"p"},"nomeFil"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"codEmp"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"codFil"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"cgc"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"empresa"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"uf"),") e retorna o primeiro item do array ",(0,r.kt)("inlineCode",{parentName:"p"},'oJson["filiais"][1]'),"."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Observa\xe7\xe3o:")," A fun\xe7\xe3o \xe9 usada para preencher o ",(0,r.kt)("inlineCode",{parentName:"p"},"name"),"/UF ao gerar JSON de estoque."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"skcarzk2--inserezk2"},"SKCarZk2 / InsereZk2"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"SKCarZk2()"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Busca produtos integrados (",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1_ATUALI = 'I'"),") que n\xe3o existem em ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2")," e insere um registro inicial por filial (lista de filiais em ",(0,r.kt)("inlineCode",{parentName:"li"},"ES_FILB2B"),")."),(0,r.kt)("li",{parentName:"ul"},"Usa ",(0,r.kt)("inlineCode",{parentName:"li"},"InsereZk2")," para a inser\xe7\xe3o.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"InsereZk2(cCodigo, cFilOri)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Obt\xe9m estoque via ",(0,r.kt)("inlineCode",{parentName:"li"},"u_specc013")," e insere em ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2")," com status ",(0,r.kt)("inlineCode",{parentName:"li"},'"N"')," (novo) e gravando data/hora/obs. Usa ",(0,r.kt)("inlineCode",{parentName:"li"},'RecLock("ZK2", .T.)')," para inserir e ",(0,r.kt)("inlineCode",{parentName:"li"},"MsUnlock()"),".")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"skenvest--genestqjson--envlotestq--atuzk2batch--updzk2batch--atuzk2ind"},"SKEnvEst / GenEstqJson / EnvLotEstq / AtuZK2Batch / UpdZK2Batch / AtuZK2Ind"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"SKEnvEst(nLoteSize, lTestMode)")," \u2014 Similar a ",(0,r.kt)("inlineCode",{parentName:"p"},"SKEnvPrd"),", mas para estoque:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Varre ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2")," buscando itens com ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2_STATUE")," indicando altera\xe7\xe3o (l\xf3gica no c\xf3digo original)."),(0,r.kt)("li",{parentName:"ul"},"Monta JSON por (",(0,r.kt)("inlineCode",{parentName:"li"},"GenEstqJson"),") e envia lotes via ",(0,r.kt)("inlineCode",{parentName:"li"},"EnvLotEstq"),"."),(0,r.kt)("li",{parentName:"ul"},"Atualiza ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2")," em lote via ",(0,r.kt)("inlineCode",{parentName:"li"},"AtuZK2Batch"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"GenEstqJson(cProdCod, cFilOri, nSaldo)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Monta JSON com ",(0,r.kt)("inlineCode",{parentName:"li"},"_id")," = produto e ",(0,r.kt)("inlineCode",{parentName:"li"},"stock")," com ",(0,r.kt)("inlineCode",{parentName:"li"},"id")," = ",(0,r.kt)("inlineCode",{parentName:"li"},'"09," + filial'),", ",(0,r.kt)("inlineCode",{parentName:"li"},"name")," = ",(0,r.kt)("inlineCode",{parentName:"li"},"filial UF")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"value")," = ",(0,r.kt)("inlineCode",{parentName:"li"},"nSaldo"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"EnvLotEstq(aLote, cToken, aErrors)"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Monta JSON array e envia (mesma l\xf3gica de retentativas do envio de produtos).")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"AtuZK2Batch / UpdZK2Batch / AtuZK2Ind"),"  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Fun\xe7\xf5es de atualiza\xe7\xe3o em lote/individual para ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK2")," (similar arquitetura a ",(0,r.kt)("inlineCode",{parentName:"li"},"ZK1"),").")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"notas-de-qualidade-melhorias-e-pontos-de-aten\xe7\xe3o"},"Notas de Qualidade, Melhorias e Pontos de Aten\xe7\xe3o"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Tratamento de erros e logs:")," O c\xf3digo usa ",(0,r.kt)("inlineCode",{parentName:"li"},"ConOut")," para logs e ",(0,r.kt)("inlineCode",{parentName:"li"},"aErrors")," para coletar erros. Seria interessante centralizar logs e adicionar n\xedveis (INFO/ERROR)."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Reuso de tokens:")," A renova\xe7\xe3o do token em cada tentativa pode ser otimizada verificando validade do token antes de renovar."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Performance em Oracle:")," A montagem do JSON a partir de v\xe1rios campos (Json1..Json99) pode produzir strings muito longas \u2014 verificar limites de ",(0,r.kt)("inlineCode",{parentName:"li"},"DBMS_LOB.SUBSTR")," e mem\xf3ria."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Encoding:")," H\xe1 muitas chamadas a ",(0,r.kt)("inlineCode",{parentName:"li"},'StrTran(..., "[UTF-8]", "")')," e ",(0,r.kt)("inlineCode",{parentName:"li"},"EncodeUTF8(...)"),". Validar encoding em origem e padronizar (usar UTF-8 consistentemente)."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Tratamento de concorr\xeancia:")," Em ",(0,r.kt)("inlineCode",{parentName:"li"},"InsereZk2")," foi usado ",(0,r.kt)("inlineCode",{parentName:"li"},"RecLock")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"MsUnlock()"),", mas \xe9 necess\xe1rio confirmar se h\xe1 tratamento de deadlock em cen\xe1rios concorrentes."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Testes e modo de simula\xe7\xe3o:")," ",(0,r.kt)("inlineCode",{parentName:"li"},"lTestMode")," implementado em fun\xe7\xf5es de envio \u2014 manter cobertura de testes unit\xe1rios para ambas as rotas (simula\xe7\xe3o e execu\xe7\xe3o real)."),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("strong",{parentName:"li"},"Documenta\xe7\xe3o inline:"),"  Blocos ",(0,r.kt)("inlineCode",{parentName:"li"},"/{Protheus.doc}")," est\xe3o presentes e foram usados como base.")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"mindmap-estrutura-hier\xe1rquica-para-importa\xe7\xe3o"},"Mindmap (estrutura hier\xe1rquica para importa\xe7\xe3o)"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Integra\xe7\xe3o Protheus SK - Fabritech",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"SKEnvPrd (envio produtos)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ParseOriginalJson"),(0,r.kt)("li",{parentName:"ul"},"GenProdJson",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"GetManufInfo"),(0,r.kt)("li",{parentName:"ul"},"GetProdGroup"),(0,r.kt)("li",{parentName:"ul"},"GetManufName"),(0,r.kt)("li",{parentName:"ul"},"GetLocCat"),(0,r.kt)("li",{parentName:"ul"},"GetRelPrdJ"),(0,r.kt)("li",{parentName:"ul"},"GetPricesJ",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"GetPrcData",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ProcPrcRecFull"))))),(0,r.kt)("li",{parentName:"ul"},"GetStockJs",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"GetStockData",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ProcStockRec",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"GetStockQt"))))))))),(0,r.kt)("li",{parentName:"ul"},"EnviaLote",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"U_EnvLoteB2B (externa)"))),(0,r.kt)("li",{parentName:"ul"},"PreparaAtualizacao"),(0,r.kt)("li",{parentName:"ul"},"AtuZK1Batch",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"UpdateBatch"),(0,r.kt)("li",{parentName:"ul"},"AtuZK1Individual"))))),(0,r.kt)("li",{parentName:"ul"},"SKEnvEst (envio estoque)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"GenEstqJson"),(0,r.kt)("li",{parentName:"ul"},"EnvLotEstq"),(0,r.kt)("li",{parentName:"ul"},"AtuZK2Batch",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"UpdZK2Batch"),(0,r.kt)("li",{parentName:"ul"},"AtuZK2Ind"))))),(0,r.kt)("li",{parentName:"ul"},"SKaltPrc (sinaliza altera\xe7\xe3o de pre\xe7o)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"ProcessaProdutoPreco",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"PUTPRECO"))))),(0,r.kt)("li",{parentName:"ul"},"SKCarZk2 (carga inicial ZK2)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"InsereZk2"))),(0,r.kt)("li",{parentName:"ul"},"Utilit\xe1rios",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Implode / StrSanitize / IsOracle / RETUFFIL")))))),(0,r.kt)("hr",null))}k.isMDXComponent=!0}}]);